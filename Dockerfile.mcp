#!/usr/bin/env bash
# ============================================
# Stage 1: Build
# ============================================
FROM node:20-slim AS builder

WORKDIR /app

COPY package*.json ./

RUN npm ci

COPY . .

RUN npm run build

# ============================================
# Stage 2: Production (MCP)
# ============================================
FROM node:20-slim AS production

RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    curl \
    && pip3 install --no-cache-dir --break-system-packages yt-dlp \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

COPY package*.json ./

RUN npm ci --only=production && npm cache clean --force

COPY --from=builder /app/dist ./dist

EXPOSE 4200

CMD ["npm", "run", "start:mcp"]
