version: "3.9"

# Whisper fallback: when YouTube subtitles are missing, the app can transcribe via Whisper.
# - Local: run the whisper service below and set WHISPER_MODE=local, WHISPER_BASE_URL=http://whisper:9000.
# - API: set WHISPER_MODE=api, WHISPER_API_KEY=sk-... (and optionally WHISPER_API_BASE_URL).
# - Off: omit or set WHISPER_MODE=off (default).

services:
  # GPU: not available in Docker on Mac (Linux VM has no GPU access). Use ASR_MODEL=tiny for faster CPU transcription.
  whisper:
    image: onerahmet/openai-whisper-asr-webservice:latest
    container_name: whisper
    environment:
      ASR_ENGINE: openai_whisper
      # base = balance; tiny = faster, lower quality; small/medium = slower, better
      ASR_MODEL: base
    ports:
      - "9000:9000"
    # Optional: persist model cache to avoid re-downloading on restart
    # volumes:
    #   - "./whisper-cache:/root/.cache"
    restart: unless-stopped

  transcriptor-mcp-api:
    image: artsamsonov/transcriptor-mcp-api:latest
    container_name: transcriptor-mcp-api
    environment:
      PORT: "3000"
      HOST: "0.0.0.0"
      YT_DLP_TIMEOUT: "60000"
      YT_DLP_JS_RUNTIMES: "node"
      COOKIES_FILE_PATH: "/cookies.txt"
      # Optional: LOG_LEVEL, YT_DLP_SKIP_VERSION_CHECK, YT_DLP_REQUIRED (see .env.example)
      # Whisper fallback (local container)
      WHISPER_MODE: "local"
      WHISPER_BASE_URL: "http://whisper:9000"
      WHISPER_TIMEOUT: "120000"
      # Without Whisper: comment out the three lines above or set WHISPER_MODE=off
      # For OpenAI API instead: WHISPER_MODE=api, WHISPER_API_KEY=sk-...
    ports:
      - "3000:3000"
    volumes:
      - "./cookies.txt:/cookies.txt"
    restart: unless-stopped

  transcriptor-mcp:
    image: artsamsonov/transcriptor-mcp:latest
    container_name: transcriptor-mcp
    command: ["npm", "run", "start:mcp:http"]
    stdin_open: true
    tty: true
    environment:
      MCP_PORT: "4200"
      MCP_HOST: "0.0.0.0"
      YT_DLP_TIMEOUT: "60000"
      YT_DLP_JS_RUNTIMES: "node"
      COOKIES_FILE_PATH: "/cookies.txt"
      # Optional: MCP_AUTH_TOKEN, MCP_ALLOWED_HOSTS, MCP_ALLOWED_ORIGINS, LOG_LEVEL (see .env.example)
      # Optional: YT_DLP_SKIP_VERSION_CHECK=1, YT_DLP_REQUIRED=0
      # Whisper fallback (local container)
      WHISPER_MODE: "local"
      WHISPER_BASE_URL: "http://whisper:9000"
      WHISPER_TIMEOUT: "120000"
    ports:
      - "4200:4200"
    volumes:
      - "./cookies.txt:/cookies.txt"
    restart: unless-stopped
